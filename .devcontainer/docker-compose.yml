version: '3'

services:
  app:
    container_name: graasp-core
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # [Choice] Node.js version: 14, 12, 10
        VARIANT: 20
        # On Linux, you may need to update USER_UID and USER_GID below if not your local UID is not 1000.
        USER_UID: 1000
        USER_GID: 1000
    environment:
      # sane default to allow the server to bind to any interface in the container
      HOSTNAME: 0.0.0.0
      # the generated links should open the browser locally
      PUBLIC_URL: http://localhost:3000
      # temporary storage for files inside the container
      FILE_STORAGE_ROOT_PATH: /tmp/graasp-file-item-storage
      # the localfile config host points to the static file server defined below
      FILE_STORAGE_HOST: http://localhost:1081
      # enpoint of the nudenet model
      IMAGE_CLASSIFIER_API: http://nudenet:8080/sync
      # the DB config is set by the "db" service below
      DB_HOST: db
      DB_NAME: graasp
      DB_USERNAME: graasper
      DB_PASSWORD: graasper
      # the Etherpad config is set by the "etherpad" service below
      ETHERPAD_URL: http://etherpad:9001
      ETHERPAD_PUBLIC_URL: http://localhost:9001
      ETHERPAD_COOKIE_DOMAIN: localhost
      # Api key is set by ./etherpad/devApiKey.txt
      ETHERPAD_API_KEY: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
      # the Redis config is set by the "redis" service below
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # the Mailer config is set by the "mailer" service below
      MAILER_CONFIG_SMTP_HOST: mailer
      MAILER_CONFIG_SMTP_PORT: 1025
      MAILER_CONFIG_SMTP_USE_SSL: 'false' # only for dev purposes
      MAILER_CONFIG_USERNAME: docker
      MAILER_CONFIG_PASSWORD: docker
      # the Localstack config is set by the "localstack" service below
      S3_FILE_ITEM_HOST: http://localstack:4566
      # the Iframely config is set by the "iframely" service below
      EMBEDDED_LINK_ITEM_IFRAMELY_HREF_ORIGIN: http://graasp-iframely:8061

    volumes:
      - ..:/workspace:cached
      - ../tmp:/tmp/graasp-file-item-storage
    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity
    ports:
      - 3000:3000

  db:
    container_name: db
    image: postgres:15
    restart: on-failure
    ports:
      - 5432:5432
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: docker
      POSTGRES_USER: docker
      POSTGRES_PASSWORD: docker
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    container_name: graasp-redis
    image: redis
    restart: on-failure

  umami:
    container_name: umami
    image: ghcr.io/umami-software/umami:postgresql-latest
    environment:
      DATABASE_URL: postgresql://umami:umami@db:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: a5b20f9ac88eb6d9c2a443664968052ee9f34a3ea8ed1ebe0c0d5c51d5ea78ca
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:3000/api/heartbeat"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - 8000:3000

  # Localstack is used to test aws services locally
  localstack:
    container_name: graasp-localstack
    image: localstack/localstack
    volumes:
      - ../tmp:/tmp/graasp-localstack
      - './localstack/init.sh:/etc/localstack/init/ready.d/init-aws.sh'
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
    ports:
      - 4566-4583:4566-4583

  localfile:
    container_name: localfile
    image: joseluisq/static-web-server:2
    environment:
      # Note: those envs are customizable but also optional
      # - SERVER_HOST=127.0.0.1
      - SERVER_PORT=80
      - SERVER_ROOT=/tmp/graasp-file-item-storage
    volumes:
      - ../tmp:/tmp/graasp-file-item-storage
    ports:
      - 1081:80

  # necessary for graasp-embedded-link-item
  iframely:
    container_name: graasp-iframely
    image: graasp/iframely:latest
    environment:
      NODE_ENV: production # required in order for the responses to not timeout
    # exposing these ports is not necessary
    # ports:
    #   - 8061:8061

  # necessary for validation
  nudenet:
    container_name: graasp-nudenet
    image: notaitech/nudenet:classifier
    # exposing these ports is not necessary
    # ports:
    #   - 8080:8080

  # a mock mailbox on port 1025 (web UI at http://localhost:1080)
  mailer:
    container_name: mailer
    image: schickling/mailcatcher
    ports:
      - "1080:1080"

volumes:
  postgres-data:
